{
    "entities": [{
        "name": "anvil_donor",
        "record_sets": [{
            "name": "default",
            "attributes": [{
                "name": "donor_id",
                "source": {
                    "fields": ["participant.participant_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }, {
                "name": "organism_type",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'Human'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "part_of_dataset_id",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'$DATASET_NAME'"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "phenotypic_sex", 
                "source": {
                    "fields": ["participant.sex"],
                    "under_condition": null,
                    "with_transformation": [{"function": "VOCAB_MAP", "parameters": ["phenotypic_sex", false]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "reported_ethnicity", 
                "source": {
                    "fields": ["participant.reported_ethnicity", "participant.reported_race"],
                    "under_condition": null,
                    "with_transformation": [{"function": "CUSTOM", "parameters": ["SPLIT((SELECT STRING_AGG(DISTINCT col, ',') FROM UNNEST(SPLIT(TRIM(FORMAT('%t', (SELECT AS STRUCT NULLIF(participant.reported_ethnicity, ''), ARRAY_TO_STRING(SPLIT(NULLIF(participant.reported_race, ''),'|'), ','))), '()'), ', ')) AS col WHERE NOT UPPER(col) = 'NULL'), ',')", "array"]}, {"function": "VOCAB_MAP", "parameters": ["reported_ethnicity", false]}], 
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }]
        }]
    }, {
        "name": "anvil_diagnosis",
        "record_sets": [{
            "name": "default",
            "attributes": [{
                "name": "diagnosis_id", 
                "source": {
                    "fields": ["phenotype.phenotype_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }, {
                "name": "donor_id", 
                "source": {
                    "fields": ["phenotype.participant_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": true
            }, {
                "name": "disease",
                "source": {
                    "fields": ["phenotype.term_id"],
                    "under_condition": "LOWER(CAST(phenotype.presence AS STRING)) = 'present'",
                    "with_transformation": [{"function": "VOCAB_MAP", "parameters": ["disease", true]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }]
        }]
    }, {
        "name": "anvil_biosample",
        "record_sets": [{
            "name": "default",
            "attributes": [{
                "name": "biosample_id",
                "source": {
                    "fields": ["analyte.analyte_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }, {
                "name": "biosample_type", 
                "source": {
                    "fields": ["analyte.primary_biosample"],
                    "under_condition": null,
                    "with_transformation": [{"function": "VOCAB_MAP", "parameters": ["biosample_type", false]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "donor_id", 
                "source": {
                    "fields": ["analyte.participant_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "donor_age_at_collection_lower_bound", 
                "source": {
                    "fields": ["analyte.age_at_collection"],
                    "under_condition": null,
                    "with_transformation": [{"function": "SAFE_CAST", "parameters": ["INT64"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "donor_age_at_collection_upper_bound", 
                "source": {
                    "fields": ["analyte.age_at_collection"],
                    "under_condition": null,
                    "with_transformation": [{"function": "SAFE_CAST", "parameters": ["INT64"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "donor_age_at_collection_unit", 
                "source": {
                    "fields": ["analyte.age_at_collection"],
                    "under_condition": "SAFE_CAST(analyte.age_at_collection AS INT64) IS NOT NULL",
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'Years'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "part_of_dataset_id",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'$DATASET_NAME'"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }]
        }]
    }, {
        "name": "anvil_file",
        "record_sets": [{
            "name": "default",
            "attributes": [{
                "name": "file_id",
                "source": {
                    "fields": ["file_inventory.file_ref"],
                    "under_condition": null,
                    "with_transformation": [],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }, {
                "name": "file_format",
                "source": {
                    "fields": ["file_inventory.full_extension"],
                    "under_condition": null,
                    "with_transformation": [{"function": "VALUE_FILTER", "parameters": ["'Other'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "file_ref", 
                "source": {
                    "fields": ["file_inventory.file_ref"],
                    "under_condition": null,
                    "with_transformation": [],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "file_name", 
                "source": {
                    "fields": ["file_inventory.name"],
                    "under_condition": null,
                    "with_transformation": [],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "file_size", 
                "source": {
                    "fields": ["file_inventory.size_in_bytes"],
                    "under_condition": null,
                    "with_transformation": [],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "file_md5sum", 
                "source": {
                    "fields": ["file_inventory.md5_hash"],
                    "under_condition": null,
                    "with_transformation": [],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }]
        }]
    }, {
        "name": "anvil_dataset",
        "record_sets": [{
            "name": "default",
            "attributes": [{
                "name": "dataset_id",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'$DATASET_NAME'"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": true
            }, {
                "name": "consent_group",
                "source": {
                    "fields": ["workspace_attributes.value"],
                    "under_condition": "workspace_attributes.attribute = 'library:dataUseRestriction'",
                    "with_transformation": [],
                    "with_row_aggregation": {"function": "MAX", "partition_by": "1", "order_by": null},
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "data_use_permission",
                "source": {
                    "fields": ["workspace_attributes.value"],
                    "under_condition": "workspace_attributes.attribute = 'library:dataUseRestriction'",
                    "with_transformation": [],
                    "with_row_aggregation": {"function": "MAX", "partition_by": "1", "order_by": null},
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "owner",
                "source": {
                    "fields": ["workspace_attributes.value"],
                    "under_condition": "workspace_attributes.attribute = 'library:datasetOwner'",
                    "with_transformation": [],
                    "with_row_aggregation": {"function": "MAX", "partition_by": "1", "order_by": null},
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "registered_identifier",
                "source": {
                    "fields": ["workspace_attributes.value"],
                    "under_condition": "workspace_attributes.attribute = 'phs_id'",
                    "with_transformation": [],
                    "with_row_aggregation": {"function": "MAX", "partition_by": "1", "order_by": null},
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }, {
                "name": "title",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'$DATASET_NAME'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "data_modality",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "CUSTOM", "parameters": ["(SELECT FIRST_VALUE(mapped_value) OVER (ORDER BY 1) FROM `dsp-data-ingest.transform_resources.dataset_map` WHERE attribute = 'data_modality' and dataset = '$DATASET_NAME')", "non-array"]}, {"function": "SPLIT", "parameters":[","]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }]
        }]
    }, {
        "name": "anvil_project",
        "record_sets": [{
            "name": "default",
            "attributes": [{
                "name": "project_id",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'$PROJECT_NAME'"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": true
            }, {
                "name": "generated_dataset_id",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'$DATASET_NAME'"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "title",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'$PROJECT_NAME'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "registered_identifier",
                "source": {
                    "fields": ["workspace_attributes.value"],
                    "under_condition": "workspace_attributes.attribute = 'phs_id'",
                    "with_transformation": [],
                    "with_row_aggregation": {"function": "MAX", "partition_by": "1", "order_by": null},
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": false
            }]
        }]
    }, {
        "name": "anvil_activity",
        "record_sets": [{
            "name": "aligned_dna_short_read",
            "attributes": [{
                "name": "activity_id",
                "source": {
                    "fields": ["aligned_dna_short_read.aligned_dna_short_read_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "PREFIX", "parameters": ["non-array", "'aligned_dna_short_read'", "{previous}"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }, {
                "name": "activity_type",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'AlignmentActivity'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "generated_file_id", 
                "source": {
                    "fields": ["aligned_dna_short_read.aligned_dna_short_read_file", "aligned_dna_short_read.aligned_dna_short_read_index_file"],
                    "under_condition": null,
                    "with_transformation": [{"function": "VALIDATE_UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": true
            }, {
                "name": "used_biosample_id",
                "source": {
                    "fields": ["experiment_dna_short_read.analyte_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }]
        }, {
            "name": "aligned_rna_short_read",
            "attributes": [{
                "name": "activity_id",
                "source": {
                    "fields": ["aligned_rna_short_read.aligned_rna_short_read_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "PREFIX", "parameters": ["non-array", "'aligned_rna_short_read'", "{previous}"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }, {
                "name": "activity_type",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'AlignmentActivity'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "generated_file_id", 
                "source": {
                    "fields": ["aligned_rna_short_read.aligned_rna_short_read_file", "aligned_rna_short_read.aligned_rna_short_read_index_file"],
                    "under_condition": null,
                    "with_transformation": [{"function": "VALIDATE_UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": true
            }, {
                "name": "used_biosample_id",
                "source": {
                    "fields": ["experiment_rna_short_read.analyte_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }]
        }]
    }, {
        "name": "anvil_variantcallingactivity",
        "record_sets": [{
            "name": "called_variants_dna_short_read",
            "attributes": [{
                "name": "variantcallingactivity_id",
                "source": {
                    "fields": ["called_variants_dna_short_read.called_variants_dna_short_read_id"],
                    "under_condition": null,
                    "with_transformation": [{"function": "PREFIX", "parameters": ["non-array", "'called_variants_dna_short_read'", "{previous}"]}, {"function": "UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }, {
                "name": "activity_type",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'VariantCallActivity'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "data_modality",
                "source": {
                    "fields": [],
                    "under_condition": null,
                    "with_transformation": [{"function": "HARDCODE", "parameters": ["'Genomic'"]}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": false
            }, {
                "name": "generated_file_id", 
                "source": {
                    "fields": ["called_variants_dna_short_read.called_variants_dna_file"],
                    "under_condition": null,
                    "with_transformation": [{"function": "VALIDATE_UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": false
                },
                "required": true
            }, {
                "name": "used_file_id",
                "source": {
                    "fields": ["aligned_dna_short_read.aligned_dna_short_read_file"],
                    "under_condition": null,
                    "with_transformation": [{"function": "VALIDATE_UUID", "parameters": []}],
                    "with_row_aggregation": null,
                    "with_column_aggregation": null,
                    "all_fields_required": true
                },
                "required": true
            }]
        }]
    }]
}